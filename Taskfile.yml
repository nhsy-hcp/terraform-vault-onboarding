# https://taskfile.dev

version: '3'

dotenv: ['.env']

vars:
  TF_DIRS:
    sh: ls -d bootstrap namespace-* modules/*/ 2>/dev/null | xargs

tasks:
  lint:
    desc: Run all pre-commit hooks
    cmds:
      - pre-commit run --all-files

  clean:
    desc: Remove all .terraform directories and lock files
    cmds:
      - find . -name ".terraform" -type d -prune -exec rm -rf {} +
      - find . -name ".terraform.lock.hcl" -type f -delete

  init:
    desc: Initialize Terraform (no backend) for all primary directories
    cmds:
      - for: { var: TF_DIRS }
        cmd: terraform -chdir={{.ITEM}} init -upgrade -backend=false

  validate:
    desc: Initialize and validate all Terraform configurations
    deps: [init]
    sources:
      - "{{.ITEM}}/*.tf"
      - "{{.ITEM}}/*.hcl"
    cmds:
      - for: { var: TF_DIRS }
        cmd: |
          echo "--> Validating: {{.ITEM}}"
          terraform -chdir={{.ITEM}} validate

  bootstrap:apply:
    desc: Apply bootstrap infrastructure
    dir: ./bootstrap
    preconditions:
      - &tfvars_precondition
        sh: test -f terraform.tfvars
        msg: "terraform.tfvars not found. Copy terraform.tfvars.example to terraform.tfvars."
    cmds:
      - terraform init
      - terraform apply -auto-approve
      - task: update-env

  bootstrap:destroy:
    desc: Destroy bootstrap infrastructure
    dir: ./bootstrap
    cmds:
      - terraform destroy

  bootstrap:plan:
    desc: Plan bootstrap infrastructure changes
    dir: ./bootstrap
    preconditions:
      - *tfvars_precondition
    cmds:
      - terraform init
      - terraform plan

  bootstrap:refresh:
    desc: Refresh bootstrap state
    dir: ./bootstrap
    cmds:
      - terraform plan -refresh-only

  debug:
    desc: Debug variable evaluation
    cmds:
      - echo "TF_DIRS = {{.TF_DIRS}}"

  test-ci:
    desc: Run GitHub Actions locally using act (requires Docker)
    preconditions:
      - sh: command -v act >/dev/null 2>&1
        msg: "act is not installed. Install it with 'brew install act' or visit https://github.com/nektos/act"
    cmds:
      - task: clean
      - act --validate
      - act --container-architecture linux/amd64 -P ubuntu-latest=catthehacker/ubuntu:act-latest
      - task: clean

  vault:status:
    desc: Check Vault status
    cmds:
      - vault status

  update-env:
    desc: Update .env file from Terraform outputs
    cmds:
      - ./scripts/update_env.sh
    silent: true
